name: Deploy Pull Request

on: [pull_request, workflow_dispatch]

jobs:
  deploy:
    name: ğŸ›º Deploy Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›‚ Extract branch name
        shell: bash
        run: |
          HEAD_REF=$(printf "%q" "${{ github.event.ref }}")

          echo "Branch name is $HEAD_REF"

          HEAD_REF=${HEAD_REF/refs\/heads\//}
          HEAD_REF=${HEAD_REF/\//-}
          
          echo "Sanitized branch name is $HEAD_REF"

          if [[ -z "$GITHUB_OUTPUT" ]]; then
            echo "::set-output name=branch::$(eval printf "%s" "$HEAD_REF")"
          else
            echo "branch=$(eval printf "%s" "$HEAD_REF")" >> "$GITHUB_OUTPUT"
          fi
        id: extract_branch
      - name: âš™ï¸ Checkout
        uses: actions/checkout@v3
      - name: ğŸš Cache
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'npm'
      - name: ğŸ›  Build
        run: |
          npm ci
          HUGO_BASEURL="/design-system/${{ steps.extract_branch.outputs.branch }}/" npm run build
#      - name: ğŸ“‚ SFTP Deploy
#        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
#        with:
#          username: ${{ secrets.USER }}
#          server: ${{ secrets.SERVER }}
#          port: 22
#          ssh_private_key: ${{ secrets.SSH_KEY }}
#          local_path: ./dist/
#          remote_path: /srv/sites/www/www/design-system/${{ steps.extract_branch.outputs.branch }}/
#          # sftp_only: # optional
#          # sftpArgs: # optional
#          # delete_remote_files: # optional

      - name: ğŸ’¬ Leave a message
        uses: mshick/add-pr-comment@v1
        with:
          message: |
            ## ğŸ›º Branch preview has been deployed!
            ğŸ‘‰ <https://www.paris-web.fr/design-system/${{ steps.extract_branch.outputs.branch }}/index.html/>
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          repo-token-user-login: 'github-actions[bot]'
          allow-repeats: false
